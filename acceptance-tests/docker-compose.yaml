name: pokedex_verse-acceptance-tests

services:
  pokedex_verse:
    image: registry.gitlab.com/arquivei/dockerimages/go:1.23-alpine
    working_dir: /go/src/gitlab.com/arquivei/stark/templates/api
    ports:
      - 8000:8000
      - 9000:9000
    volumes:
      - ./scripts/health-check.sh:/health-check.sh:ro
      - './:/go/src/gitlab.com/arquivei/stark/templates/api'
    environment:
      APP_LOG_LEVEL: "DEBUG"
      APP_LOG_HUMAN: "true"
      APP_ADMINSERVER_ADDR: "0.0.0.0:9000"
      APP_SHUTDOWN_TIMEOUT: "1m"
      HTTP_PORT: '8000'
    entrypoint:
      - go
      - run
      - -tags=musl
      - -mod=vendor
      - ./cmd/pokedex_verse

  ## If any mocks are needed
  ##mock-server:
  ##  image: registry.gitlab.com/arquivei/stark/ssm:latest
  ##  volumes:
  ##    - ./mock-data:/data:ro

  acceptance-tests:
    image: ghcr.io/orange-opensource/hurl:latest
    volumes:
      - ./test-cases:/tests:ro
      - ../dist/reports:/reports
    depends_on:
      pokedex_verse:
        required: true
        condition: service_healthy
    entrypoint:
      - hurl
      - --glob=/tests/**/*.hurl
      - --test
      - --error-format=long
      - --report-junit=/reports/acceptance-tests.xml
